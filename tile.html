<!DOCTYPE html>
<html>

<head>
    <title>Game Board</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        .tile {
            width: 50px;
            height: 50px;
            border: 1px solid black;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 5px;
            background-color: #ffffff
        }

        .hover {
            background-color: #55CDFC;
        }

        .pressed {
            background-color: #f7a8b8;
        }
    </style>
</head>

<body>

    <div class="d-flex flex-column justify-content-center align-items-center my-5">
        <div id="board" class="d-flex flex-wrap"></div>
        <div class="container text-center">
            <p id="text1"></p>
            <p id="text2"></p>
        </div>
    </div>
    <script>
        let matrix_str = "WIIINNNNNNNNNAAA";
        let n = Math.floor(Math.sqrt(matrix_str.length)); // number of rows and columns
        const m = 3; // maximum number of tiles that can be pressed
        let pressedCount = 0;
        let selectedIndices = [];

        let counts = { 'W': 1, 'I': 3, "N": 9, 'A': 3 }; // dictionary with character keys and integer values
        let character_list = Object.keys(counts);
        let amount_list = Object.values(counts);
        let currency_list = [.5, .1, .01, .8]; // array of floats
        function hover() {
  this.classList.add('hover');
}

function unhover() {
  this.classList.remove('hover');
}
        function stringToMatrix(s) {
            let n = Math.floor(Math.sqrt(s.length));
            let matrix = [];
            for (let i = 0; i < s.length; i += n) {
                matrix.push(s.slice(i, i + n).split(''));
            }
            return matrix;
        }

        let matrix = stringToMatrix(matrix_str);

        const board = document.getElementById('board');
        board.style.width = `${n * 60}px`;

        for (let i = 0; i < n; i++) {
            for (let j = 0; j < n; j++) {
                const tile = document.createElement('div');
                tile.classList.add('tile');
                tile.addEventListener('mouseover', hover);
                tile.addEventListener('mouseout', unhover);
                board.appendChild(tile);

                // create a closure to capture the row and column indices
                (function (row, col) {
                    tile.addEventListener('click', function () {
                        click.call(this, row, col);
                    });
                    tile.addEventListener('showAllTileTexts', function () {
                        showAllTileTexts.call(this, row, col);
                    });
                })(i, j);
            }
        }
        let text1 = `Amount of Tries: ${pressedCount}` + Object.entries(counts).map(([value, count]) => ` ${value}: ${count}`).join('');
        document.getElementById('text1').innerHTML = text1;

        let text2 = 'Money Calculation: ' + currency_list.map((value, i) => `(${value} X ${Object.values(counts)[i]})`).join(' + ') + ' = ' + `$${currency_list.reduce((acc, value, i) => acc + value * Object.values(counts)[i], 0).toFixed(2)}`;
        document.getElementById('text2').innerHTML = text2;

        function click(row, col) {
            if (pressedCount < m) {
                
                this.textContent = matrix[row][col];
                selectedIndices.push([row, col]);
                this.removeEventListener('mouseover', hover);
                this.removeEventListener('mouseout', unhover);
                this.classList.remove('hover');
                this.classList.add('pressed');
                pressedCount++;
                let text1 = `Amount of Tries: ${pressedCount}` + Object.entries(counts).map(([value, count]) => ` ${value}: ${count}`).join('');
                document.getElementById('text1').innerHTML = text1;

                let text2 = 'Money Calculation: ' + currency_list.map((value, i) => `(${value} X ${Object.values(counts)[i]})`).join(' + ') + ' = ' + `$${currency_list.reduce((acc, value, i) => acc + value * Object.values(counts)[i], 0).toFixed(2)}`;
                document.getElementById('text2').innerHTML = text2;
                if (pressedCount === m) {
                    disableAllTiles();
                    const tiles = document.querySelectorAll('.tile');
                    tiles.forEach(tile => {
                        tile.dispatchEvent(new Event('showAllTileTexts'));
                    });
                    console.log(matrix);
                    console.log(selectedIndices);
                    generateXLSX(matrix, selectedIndices, character_list, amount_list, currency_list)
                }
            }
        }
        
        function disableAllTiles() {
            const tiles = document.querySelectorAll('.tile');
            tiles.forEach(tile => {
                tile.removeEventListener('click', click);
                if (!tile.classList.contains('pressed')) {
                    tile.style.backgroundColor = 'white';
                }
            });
        }

        function showAllTileTexts(row, col) {
            this.textContent = matrix[row][col];
        }
        async function generateXLSX(data, coordinates, characters, counts, values) {
            // Load the required library
            const ExcelJS = window.ExcelJS;
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Sheet1');

            // Add the data to the worksheet
            worksheet.getCell('A1').value = 'Board';
            worksheet.getCell('A1').font = { bold: true };
            data.forEach((row, rowIndex) => {
                row.forEach((cell, cellIndex) => {
                    worksheet.getCell(rowIndex + 2, cellIndex + 1).value = cell;
                });
            });

            // Set the background color for the specified cells
            coordinates.forEach(coord => {
                worksheet.getCell(coord[0] + 2, coord[1] + 1).fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF7A8B8' }
                };
            });

            // Add the summary table to the worksheet
            let startRow = data.length + 4;
            worksheet.getCell(startRow, 2).value = 'Total';
            worksheet.getCell(startRow, 2).font = { bold: true };
            worksheet.getCell(startRow, 3).value = 'Found (F)';
            worksheet.getCell(startRow, 3).font = { bold: true };
            worksheet.getCell(startRow, 4).value = 'Value (V)';
            worksheet.getCell(startRow, 4).font = { bold: true };
            worksheet.getCell(startRow, 5).value = '(F * V)';
            worksheet.getCell(startRow, 5).font = { bold: true };
            worksheet.getCell(startRow, 6).value = 'Winnings';
            worksheet.getCell(startRow, 6).font = { bold: true };

            characters.forEach((char, index) => {
                let row = startRow + index + 1;
                worksheet.getCell(row, 1).value = char;
                worksheet.getCell(row, 1).font = { bold: true };
                worksheet.getCell(row, 2).value = counts[index];
                let foundCount = coordinates.reduce((acc, [x, y]) => acc + (data[x][y] === char ? 1 : 0), 0);
                worksheet.getCell(row, 3).value = foundCount;
                worksheet.getCell(row, 4).value = values[index];
                let winnings = foundCount * values[index];
                worksheet.getCell(row, 5).value = winnings;
                if (winnings > counts[index]) {
                    worksheet.getCell(row, 6).value = winnings - counts[index];
                }
                else {
                    worksheet.getCell(row, 6).value = 0;
                }
            });

            // Generate the xlsx file and initiate download
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = 'output.xlsx';
            link.click();
        }
    </script>
</body>

</html>